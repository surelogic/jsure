<?xml version="1.0" encoding="UTF-8"?>
<project name="headlessBuilder" default="load jsure-tests.properties file" basedir=".">

	<taskdef resource="net/sf/antcontrib/antlib.xml">
		<classpath>
			<pathelement location="${user.dir}/lib/ant-contrib.jar" />
		</classpath>
	</taskdef>

	<taskdef resource="sl-tasks.properties">
		<classpath>
			<pathelement location="${user.dir}/lib/jsure-tests-ant-tasks.jar" />
		</classpath>
	</taskdef>

	<target name="load jsure-tests.properties file">
		<!-- Filenames for the properties files we are going to try to read -->
		<property name="jt.p" value="${user.home}/jsure-tests.properties" />
		<property name="dot.jt.p" value="${user.home}/.jsure-tests.properties" />

		<!-- Check for existance of "jsure-tests.properties" file -->
		<available property="jsure-tests.properties.file" value="${jt.p}" file="${jt.p}" />
		<!-- or for ".fluid-build.properties" file (to be Unix friendly) -->
		<available property="jsure-tests.properties.file" value="${dot.jt.p}" file="${dot.jt.p}" />

		<fail message="No '${fb.p}' or '.${fb.p}' file exists - please use one of these files to setup a JSure test configuration" unless="jsure-tests.properties.file" />
		<!-- Read the build properties file -->
		<property file="${jsure-tests.properties.file}" />

		<!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->
	</target>

	<target name="show-all-properties" depends="load jsure-tests.properties file" description="Prints all properties that are currently set in the project.">
		<echoproperties />
	</target>

	<target name="initialize" unless="${init.already.run}" description="Initializes the build by generating properties, cleaning the sandbox, and installing the desired version of Eclipse in it" depends="load jsure-tests.properties file">

		<!-- Make the sandbox if it doesn't exist -->
		<mkdir dir="${test.sandbox}" />

		<!-- Clean out the working directory -->
		<echo>################## CLEANING SANDBOX: ${test.sandbox} ####################</echo>
		<if>
			<equals arg1="${delete.test.module}" arg2="true" />
			<then>
				<echo>Deleting everything in ${test.sandbox}</echo>
				<delete dir="${test.sandbox}" includeemptydirs="true" />

				<!-- Make the sandbox if the delete command deleted it -->
				<mkdir dir="${test.sandbox}" />
			</then>
			<else>
				<echo>Keeping the regression suite (Danger! Will Robinson, Danger!)</echo>
				<delete includeemptydirs="true">
					<fileset dir="${test.sandbox}" excludes="${test.module}/**" />
				</delete>
			</else>
		</if>

		<!-- The path to the zip/tgz/tar of the eclipse distro that should be tested against -->
		<findfile property="eclipse.archive" basedir="${eclipse.zip.dir}" regex="${eclipse.zip.regex}" />

		<geteclipseversion file="${eclipse.archive}" property="eclipse.version" />

		<!-- The path to the zip of the eclipse test plugin distro that should be tested against -->
		<findfile property="eclipse.test.zip" basedir="${eclipse.zip.dir}" regex="eclipse-test-framework-${eclipse.version}.zip" />
		<!-- Unzip our Eclipse install and the related test-framework plugin -->
		<getfileextension property="extension" file="${eclipse.archive}" />
		<if>
			<equals arg1="${extension}" arg2="zip" />
			<then>
				<unzip dest="${test.sandbox}" src="${eclipse.archive}" />
			</then>
			<!-- We have to run an OS-specific tar command as the Ant one
			     does not set executable files on OS X and Linux properly
			     (in fact this is why Eclipse uses tar.gz rather than zip
			     for distributions on these OSs) -->
			<elseif>
				<equals arg1="${extension}" arg2="tgz" />
				<then>
					<exec executable="/usr/bin/env">
						<arg value="tar" />
						<arg value="xfz" />
						<arg value="${eclipse.archive}" />
						<arg value="-C" />
						<arg value="${test.sandbox}" />
					</exec>
				</then>
			</elseif>
			<elseif>
				<equals arg1="${extension}" arg2="gz" />
				<then>
					<exec executable="/usr/bin/env">
						<arg value="tar" />
						<arg value="xfz" />
						<arg value="${eclipse.archive}" />
						<arg value="-C" />
						<arg value="${test.sandbox}" />
					</exec>
				</then>
			</elseif>
			<elseif>
				<equals arg1="${extension}" arg2="tar" />
				<then>
					<exec executable="/usr/bin/env">
						<arg value="tar" />
						<arg value="xf" />
						<arg value="${eclipse.archive}" />
						<arg value="-C" />
						<arg value="${test.sandbox}" />
					</exec>
				</then>
			</elseif>
			<else>
				<fail message="No Eclipse archive found in ${eclipse.zip.dir}" />
			</else>
		</if>

		<unzip dest="${test.sandbox}" src="${eclipse.test.zip}" />

		<findfile basedir="${eclipse.dir}/plugins" regex="org\.eclipse\.equinox\.launcher_.*\.jar" property="eclipse.startup.jar" />

		<geteclipseversion file="${eclipse.archive}" property="eclipse.version" />

		<!-- Set the directory where the pde plugin is installed under eclipse -->
		<findfile property="pde.plugin.dir" basedir="${eclipse.dir}/plugins" regex="org\.eclipse\.pde\.build_.*" />

		<!-- support the pde build scripts by generating the build.properties 
		(copying the generated fluid-build.properties) -->
		<copy file="${user.home}/${test.properties}" toFile="${build.dir}/build.properties" />

		<!-- Ensures we don't init 2x in one run -->
		<property name="init.already.run" value="true" />
	</target>

	<target name="init.regression.tests" depends="initialize" description="Sets up the workspaces for any regression test projects">

		<!-- make a copy of the test module in the workspace this was started within -->
		<copy todir="${test.sandbox}/${test.module}">
			<fileset dir="${test.module.path.to.copy.from}/${test.module}" />
		</copy>

		<mkdir dir="${test.workspace.base}" />
		<mkdir dir="${test.log.base}" />

		<!-- unzip any zipped tests -->
		<findtests property="test.project.list" basedir="${test.module.dir}" fullpaths="false" />
		<for list="${test.project.list}" param="name" trim="true" keepgoing="true">
			<sequential>
				<if>
					<matches string="@{name}" pattern="(.*)\.zip$" />
					<then>
						<propertyregex property="zip.name" input="@{name}" regexp="([^\.]*)\.zip" select="\1" override="true" casesensitive="false" />
						<echo message="Unzipping @{name}" />
						<mkdir dir="${test.module.dir}/${zip.name}" />
						<unzip src="${test.module.dir}/@{name}" dest="${test.module.dir}/${zip.name}" />
					</then>
					<else>
						<echo message="No extra processing needed for @{name}" />
					</else>
				</if>
			</sequential>
		</for>

		<!-- make sure the workspaces contain any test.properties files from the project -->
		<copy todir="${test.workspace.base}">
			<fileset dir="${test.module.dir}" includes="**/test.properties" />
		</copy>
	</target>

	<target name="build.all.plugins" description="Build all of the SureLogic JSure plugins" depends="initialize">
		<mkdir dir="${build.dir}/features" />
		<mkdir dir="${build.dir}/plugins" />


		<!-- Copy our plugins  -->
		<for list="${plugin.projects}" delimiter="," param="plugin" trim="true" keepgoing="true">
			<sequential>
				<copy todir="${build.dir}/plugins/@{plugin}">
					<fileset dir="../../@{plugin}">
						<exclude name="bin/**,**/CVS/**,**/.svn/**" />
					</fileset>
				</copy>
			</sequential>
		</for>

		<!-- Copy our features  -->
		<for list="${feature.projects}" delimiter="," param="feature" trim="true" keepgoing="true">
			<sequential>
				<copy todir="${build.dir}/features/@{feature}">
					<fileset dir="../../@{feature}" />
				</copy>
			</sequential>
		</for>

		<move file="${build.dir}/features/jsure-tests-feature" toFile="${build.dir}/features/com.surelogic.jsure.tests" />
		<ant antfile="build-src.xml" dir="${build.dir}/plugins/common/" />
		<ant antfile="build-src.xml" dir="${build.dir}/plugins/fluid/" />

		<java dir="${pde.plugin.dir}/scripts" jar="${eclipse.startup.jar}" fork="true" maxmemory="1000M" failonerror="true">
			<arg line="-application org.eclipse.ant.core.antRunner" />
			<arg value="-Dbuilder=${build.dir}" />
		</java>

		<!-- Install into the Eclipse  -->

	</target>

	<macrodef name="build.plugins">
		<attribute name="test" default="false" />
		<sequential>
			<java dir="${pde.plugin.dir}/scripts" jar="${eclipse.startup.jar}" fork="true" maxmemory="1000M" failonerror="true">
				<arg line="-application org.eclipse.ant.core.antRunner" />
				<arg value="-Dtest=@{test}" />
				<arg value="-Dbuilder=${build.dir}" />
				<arg value="-Dbase=${root}/" />
				<arg value="-DbaseLocation=${test.sandbox}/eclipse" />
				<arg value="-Dworkspace=${dev.workspace.dir}/" />
				<arg value="-DbuildDirectory=${build.dir}/" />
				<arg value="-Dtest.sandbox=${test.sandbox}" />
				<arg value="-Dtest.properties=${test.properties}" />
				<arg value="-Dtest.workspace.base=${test.workspace.base}" />
				<arg value="-Dtest.module.dir=${test.module.dir}" />
			</java>
		</sequential>
	</macrodef>


	<target name="build.and.test.all.plugins" description="Build all of the SureLogic JSure plugins, the test plugins, and run the tests" depends="init.regression.tests">
		<build.plugins test="true" />
	</target>

	<!-- SUMMARIZES THE RESULTS AND PRINTS THEM OUT -->
	<target name="summarize.results" description="Summarizes the regression and unit test results" depends="build.and.test.all.plugins, collect-test-results">

		<echo>
############################################################
#               ANNOTATION RULES RESULTS                   #
############################################################
		</echo>

		<findtests property="test.project.list" basedir="${test.workspace.base}" fullpaths="true" />
		<for list="${test.project.list}" param="workspace" trim="true" keepgoing="true">
			<sequential>
				<if>
					<matches string="@{workspace}" pattern="(.*)UnitTests$" />
					<then>
						<echo message="Skipping the UnitTests workspace" />
					</then>
					<else>
						<testresults file="@{workspace}/AnnotationRules.log.Tests.xml" logfile="${reg.tests.log.file}" property="tests.failed" />
					</else>
				</if>
			</sequential>
		</for>

		<echo>
############################################################
#                  ECLIPSE LOG RESULTS                     #
############################################################
		</echo>

		<findtests property="test.project.list" basedir="${test.workspace.base}" fullpaths="false" />
		<for list="${test.project.list}" param="workspace" trim="true" keepgoing="true">
			<sequential>
				<if>
					<matches string="@{workspace}" pattern="(.*)UnitTests$" />
					<then>
						<echo message="Skipping the UnitTests workspace" />
					</then>
					<else>
						<testresults file="${test.workspace.base}/@{workspace}/@{workspace}.log.Tests.xml" logfile="${reg.tests.log.file}" property="tests.failed" />
					</else>
				</if>
			</sequential>
		</for>
		<echo>
############################################################
#                REGRESSION TEST RESULTS                   #
############################################################
		</echo>

		<findtests property="test.project.list" basedir="${test.workspace.base}" fullpaths="true" />
		<for list="${test.project.list}" param="workspace" trim="true" keepgoing="true">
			<sequential>
				<if>
					<matches string="@{workspace}" pattern="(.*)UnitTests$" />
					<then>
						<echo message="Skipping the UnitTests workspace" />
					</then>
					<else>
						<testresults file="@{workspace}/com.surelogic.jsure.tests.AllRegressionTests.xml" tests="com.surelogic.jsure.tests.RegressionTest:testMajordomo" printtestname="false" logfile="${reg.tests.log.file}" property="tests.failed" />
					</else>
				</if>
			</sequential>
		</for>

		<echo>
############################################################
#                  JUNIT TEST RESULTS                      #
############################################################
		</echo>

		<testresults file="${test.workspace.base}/UnitTests/com.surelogic.jsure.tests.AllUnitTests.xml" logfile="${unit.tests.log.file}" property="tests.failed" />

		<if>
			<equals arg1="${tests.failed}" arg2="FAILED" />
			<then>
				<echo>
####################################################
					
					
      !!!!!!!!!!   	FAILURE		  !!!!!!!!!		   
					
					 
####################################################
				</echo>
				<fail message="One or more regression tests and/or unit tests failed. Check the sl.reg.test.results.txt and sl.unit.test.results.txt files in ${test.sandbox} to determine what tests in what projects failed. From there, look at the com.surelogic.jsure.tests.AllTests.xml file in the failed ${test.sandbox}/workspaces/[project] folder." />
			</then>
			<else>
				<echo>
####################################################
					
					
#              		SUCCESS						   #
					
					
####################################################
				</echo>
			</else>
		</if>
	</target>


	<!-- Gathers our regression and Unit test results -->
	<target name="collect-test-results">
		<property file="${user.home}/fluid-build.properties" />
		<property file="${user.home}/sl.test.properties" />

		<findtests property="test.project.list" basedir="${test.workspace.base}" fullpaths="true" />
		<for list="${test.project.list}" param="project" trim="true" keepgoing="true">
			<sequential>
				<filenamefrompath file="@{project}" property="proj-name" />
				<copy todir="${test.log.base}">
					<mapper>
						<chainedmapper>
							<flattenmapper />
							<globmapper from="*.xml" to="${proj-name}-*.xml" />
						</chainedmapper>
					</mapper>

					<fileset dir="@{project}">
						<include name="*.xml" />
					</fileset>
				</copy>

			</sequential>
		</for>
		<move todir="${test.log.base}">
			<mapper>
				<globmapper from="UnitTests-*" to="*" />
			</mapper>
			<fileset dir="${test.log.base}">
				<include name="*.xml" />
			</fileset>
		</move>
	</target>

</project>
